name: Android Build with Kivy-A.T.

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      # Default Android SDK path used by Buildozer
      ANDROID_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
      # SDK command-line tools URL (Updated to a known working path)
      CMDLINE_TOOLS_URL: https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

    steps:
    - uses: actions/checkout@v4

    # 1. Install Buildozer environment dependencies (includes git, python, openjdk, curl, unzip)
    - name: Set up Buildozer Environment
      run: |
        sudo apt update
        # Install build dependencies, Java, and necessary tools (curl, unzip)
        sudo apt install -y build-essential python3-pip git openjdk-17-jdk curl unzip

    # 2. Install Python dependencies
    - name: Install Python Dependencies
      run: |
        pip install buildozer pip
        pip install cython==0.29.36

    # 3. Accept Android SDK Licenses (Fixes initial "license not accepted" error)
    - name: Accept Android SDK Licenses
      run: |
        mkdir -p $ANDROID_HOME/licenses
        echo "2433ddef7fe487ef9c12257c191a92e18ae5703f" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b940e6990c46a6f1317565b535028883d6a" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
    # 4. Manually install SDK Command-Line Tools (Fixes "sdkmanager not installed")
    - name: Install Latest SDK Command-Line Tools
      run: |
        TOOLS_DIR=$ANDROID_HOME/cmdline-tools
        TOOLS_ZIP="cmdline-tools.zip"
        
        # Use curl for a more robust download
        echo "Downloading SDK Command-Line Tools..."
        curl -fL -o $TOOLS_ZIP $CMDLINE_TOOLS_URL
        
        # Crude size check
        FILE_SIZE=$(stat -c%s "$TOOLS_ZIP")
        if [ "$FILE_SIZE" -lt 50000000 ]; then 
          echo "Error: Downloaded file size is too small ($FILE_SIZE bytes). It might be corrupted or an error page."
          exit 1
        fi
        
        # Create target directory structure and unzip
        mkdir -p $TOOLS_DIR/latest
        unzip -q $TOOLS_ZIP -d $TOOLS_DIR/latest
        
        # Move tools to the expected directory structure 
        mv $TOOLS_DIR/latest/cmdline-tools/* $TOOLS_DIR/latest/
        
        # Cleanup
        rm $TOOLS_ZIP

    # 5. å…³é”®æ­¥éª¤ï¼šä¿®å¤ PATH ç¯å¢ƒå˜é‡å¹¶é¢„å®‰è£… Buildozer ä¾èµ–
    - name: Force Accept Licenses and Pre-install Dependencies
      run: |
        # ä¿®æ­£ï¼šå…ˆåœ¨å½“å‰ Shell ä¸­ export PATHï¼Œæ‰èƒ½ç«‹å³ä½¿ç”¨ sdkmanager
        SDK_BIN="$ANDROID_HOME/cmdline-tools/latest/bin"
        export PATH="$SDK_BIN:$PATH"
        
        # åŒæ—¶ï¼Œä½¿ç”¨ GITHUB_PATH ç¡®ä¿å…¶å¯¹åç»­æ­¥éª¤ (æ­¥éª¤ 6) ä¹Ÿæœ‰æ•ˆ
        echo "$SDK_BIN" >> $GITHUB_PATH
        
        # å¼ºåˆ¶æ¥å—æ‰€æœ‰ç¼ºå¤±çš„è®¸å¯è¯
        echo "Force accepting all Android SDK licenses..."
        yes | sdkmanager --licenses || true

        # ğŸš¨ å…³é”®ä¿®æ­£ï¼šç§»é™¤ä¸å¯ç”¨çš„ build-tools;36.1.0ï¼Œåªå®‰è£…å·²çŸ¥å¯ç”¨ç‰ˆæœ¬ã€‚
        echo "Pre-installing specific Build-Tools and dependencies..."
        sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3" "build-tools;26.1.0"

    # 6. Run buildozer compilation
    - name: Run Buildozer Android Debug
      run: buildozer android debug

    # 7. Upload generated APK file as an artifact
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: bin/*.apk
