# æ–‡ä»¶å: .github/workflows/android_build.yml

name: Android Build with Kivy-A.T.

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° 'main' åˆ†æ”¯æ—¶ï¼Œæˆ–æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œæ—¶
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # å…³é”®ä¿®æ­£ï¼šåœ¨ Job çº§åˆ«è®¾ç½® ANDROID_HOME ç¯å¢ƒå˜é‡
    env:
      # Buildozer é»˜è®¤çš„ Android SDK è·¯å¾„
      ANDROID_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk

    steps:
    - uses: actions/checkout@v4

    # 1. å®‰è£… buildozer è¿è¡Œç¯å¢ƒ (åŒ…æ‹¬ openjdk-17-jdk)
    - name: Set up Buildozer Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential python3-pip git openjdk-17-jdk

    # ğŸŒŸ æ–°å¢æ­¥éª¤ï¼šç¡®ä¿ä¸‹è½½å’Œè§£å‹å·¥å…·å­˜åœ¨ ğŸŒŸ
    - name: Ensure Wget and Unzip Tools
      run: |
        # ç¡®ä¿åœ¨è¿è¡Œ wget å’Œ unzip ä¹‹å‰ï¼Œå®ƒä»¬å·²ç»è¢«å®‰è£…
        sudo apt install -y wget unzip

    # 2. å®‰è£… Python ä¾èµ–
    - name: Install Python Dependencies
      run: |
        pip install buildozer pip
        pip install cython==0.29.36

    # 3. æ¥å— Android SDK è®¸å¯è¯ (è§£å†³ 'license not accepted' é”™è¯¯)
    - name: Accept Android SDK Licenses
      run: |
        # åˆ›å»º licenses ç›®å½•
        mkdir -p $ANDROID_HOME/licenses
        
        # å†™å…¥ SDK è®¸å¯è¯å“ˆå¸Œ
        echo "2433ddef7fe487ef9c12257c191a92e18ae5703f" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b940e6990c46a6f1317565b535028883d6a" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
    # 4. å¼ºåˆ¶å®‰è£…æœ€æ–°çš„ SDK å‘½ä»¤è¡Œå·¥å…· (è§£å†³ 'sdkmanager not installed' é”™è¯¯)
    - name: Install Latest SDK Command-Line Tools
      run: |
        # è¿™ä¸€æ­¥ä¿®å¤ Buildozer åœ¨æ–°ç‰ˆ Android SDK ç»“æ„ä¸­æ‰¾ä¸åˆ° sdkmanager çš„é—®é¢˜
        
        # ç›®æ ‡ä¸‹è½½æ–‡ä»¶å
        TOOLS_ZIP="cmdline-tools.zip"
        
        # ä¸‹è½½å¹¶è§£å‹æœ€æ–°çš„å‘½ä»¤è¡Œå·¥å…·åŒ… (Google å®˜æ–¹é“¾æ¥)
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8551475_latest.zip -O $TOOLS_ZIP
        
        # åˆ›å»ºç›®æ ‡ç›®å½•
        mkdir -p $ANDROID_HOME/cmdline-tools/latest
        
        # è§£å‹åˆ°ç›®æ ‡ç›®å½•
        unzip -q $TOOLS_ZIP -d $ANDROID_HOME/cmdline-tools/latest/
        
        # ç§»åŠ¨å·¥å…·åˆ° sdkmanager æœŸæœ›çš„ç›®å½•ç»“æ„
        mv $ANDROID_HOME/cmdline-tools/latest/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
        
        # æ¸…ç†
        rm $TOOLS_ZIP


    # 5. è¿è¡Œ buildozer ç¼–è¯‘
    - name: Run Buildozer Android Debug
      run: buildozer android debug

    # 6. ä¸Šä¼ ç”Ÿæˆçš„ APK æ–‡ä»¶
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: bin/*.apk
