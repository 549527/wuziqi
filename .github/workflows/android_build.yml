# æ–‡ä»¶å: .github/workflows/android_build.yml

name: Android Build with Kivy-A.T.

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° 'main' åˆ†æ”¯æ—¶ï¼Œæˆ–æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œæ—¶
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 1. å®‰è£… buildozer è¿è¡Œç¯å¢ƒ (å·²åŒ…å« openjdk-17-jdk)
    - name: Set up Buildozer Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential python3-pip git openjdk-17-jdk

    # 2. å®‰è£… Python ä¾èµ–
    - name: Install Python Dependencies
      run: |
        pip install buildozer pip
        # Kivy/Buildozer å¯¹ Cython ç‰ˆæœ¬å¾ˆæ•æ„Ÿï¼Œä½¿ç”¨ç¨³å®šç‰ˆæœ¬
        pip install cython==0.29.36

    # 3. æ¥å— Android SDK è®¸å¯è¯ (è§£å†³ä¹‹å‰çš„ 'license not accepted' é”™è¯¯)
    - name: Accept Android SDK Licenses
      run: |
        # Buildozer ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼ŒSDK ä¼šè¢«ä¸‹è½½åˆ°è¿™ä¸ªé»˜è®¤è·¯å¾„
        export ANDROID_HOME="$HOME/.buildozer/android/platform/android-sdk"
        
        # åˆ›å»º licenses ç›®å½•
        mkdir -p $ANDROID_HOME/licenses
        
        # å†™å…¥ SDK è®¸å¯è¯å“ˆå¸Œï¼Œæ¨¡æ‹Ÿæ‰‹åŠ¨ç‚¹å‡» "Accept"
        echo "2433ddef7fe487ef9c12257c191a92e18ae5703f" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b940e6990c46a6f1317565b535028883d6a" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
    # ğŸŒŸ 4. æ–°å¢æ­¥éª¤ï¼šå¼ºåˆ¶å®‰è£…æœ€æ–°çš„ SDK å‘½ä»¤è¡Œå·¥å…· (è§£å†³ 'sdkmanager not installed' é”™è¯¯) ğŸŒŸ
    - name: Install Latest SDK Command-Line Tools
      run: |
        # å†æ¬¡ç¡®ä¿ ANDROID_HOME å˜é‡åœ¨å½“å‰ Shell ä¸­å¯ç”¨
        export ANDROID_HOME="$HOME/.buildozer/android/platform/android-sdk"
        
        # è¿™ä¸€æ­¥æ˜¯ä¿®å¤ Buildozer åœ¨æ–°ç‰ˆ Android SDK ç»“æ„ä¸­æ‰¾ä¸åˆ° sdkmanager çš„é—®é¢˜
        # ä¸‹è½½å¹¶è§£å‹æœ€æ–°çš„å‘½ä»¤è¡Œå·¥å…·åŒ… (è¿™æ˜¯ Google å®˜æ–¹çš„ä¸‹è½½é“¾æ¥)
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8551475_latest.zip -O cmdline-tools.zip
        
        # åˆ›å»ºç›®æ ‡ç›®å½•å¹¶è§£å‹
        mkdir -p $ANDROID_HOME/cmdline-tools/latest
        unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools/latest/
        
        # ç§»åŠ¨å·¥å…·åˆ° sdkmanager æœŸæœ›çš„ç›®å½•ç»“æ„
        mv $ANDROID_HOME/cmdline-tools/latest/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/

    # 5. è¿è¡Œ buildozer ç¼–è¯‘
    - name: Run Buildozer Android Debug
      run: buildozer android debug

    # 6. ä¸Šä¼ ç”Ÿæˆçš„ APK æ–‡ä»¶
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: bin/*.apk
