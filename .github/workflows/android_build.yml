name: Android Build with Kivy-A.T.

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      # Default Android SDK path used by Buildozer
      ANDROID_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
      # SDK command-line tools URL (Updated to a known working path)
      CMDLINE_TOOLS_URL: https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

    steps:
    - uses: actions/checkout@v4

    # 1. Install Buildozer environment dependencies (includes git, python, openjdk, curl, unzip)
    - name: Set up Buildozer Environment
      run: |
        sudo apt update
        # Install build dependencies, Java, and necessary tools (curl, unzip)
        sudo apt install -y build-essential python3-pip git openjdk-17-jdk curl unzip

    # 2. Install Python dependencies
    - name: Install Python Dependencies
      run: |
        pip install buildozer pip
        pip install cython==0.29.36

    # 3. Accept Android SDK Licenses (Fixes initial "license not accepted" error)
    - name: Accept Android SDK Licenses
      run: |
        mkdir -p $ANDROID_HOME/licenses
        echo "2433ddef7fe487ef9c12257c191a92e18ae5703f" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b940e6990c46a6f1317565b535028883d6a" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
    # 4. Manually install SDK Command-Line Tools (Fixes "sdkmanager not installed")
    - name: Install Latest SDK Command-Line Tools
      run: |
        TOOLS_DIR=$ANDROID_HOME/cmdline-tools
        TOOLS_ZIP="cmdline-tools.zip"
        
        # Use curl for a more robust download
        echo "Downloading SDK Command-Line Tools..."
        curl -fL -o $TOOLS_ZIP $CMDLINE_TOOLS_URL
        
        # Crude size check
        FILE_SIZE=$(stat -c%s "$TOOLS_ZIP")
        if [ "$FILE_SIZE" -lt 50000000 ]; then 
          echo "Error: Downloaded file size is too small ($FILE_SIZE bytes). It might be corrupted or an error page."
          exit 1
        fi
        
        # Create target directory structure and unzip
        mkdir -p $TOOLS_DIR/latest
        unzip -q $TOOLS_ZIP -d $TOOLS_DIR/latest
        
        # Move tools to the expected directory structure 
        mv $TOOLS_DIR/latest/cmdline-tools/* $TOOLS_DIR/latest/
        
        # Cleanup
        rm $TOOLS_ZIP

    # 5. 关键步骤：修复 PATH 环境变量并预安装 Buildozer 依赖
    - name: Force Accept Licenses and Pre-install Dependencies
      run: |
        # 修正：先在当前 Shell 中 export PATH，才能立即使用 sdkmanager
        SDK_BIN="$ANDROID_HOME/cmdline-tools/latest/bin"
        export PATH="$SDK_BIN:$PATH"
        
        # 同时，使用 GITHUB_PATH 确保其对后续步骤 (步骤 6) 也有效
        echo "$SDK_BIN" >> $GITHUB_PATH
        
        # 强制接受所有缺失的许可证
        echo "Force accepting all Android SDK licenses..."
        # 这里的 sdkmanager 现在应该能找到
        yes | sdkmanager --licenses || true

        # 预安装 Buildozer 最常依赖的组件，解决 Aidl 缺失和 Build-Tools 许可证问题
        echo "Pre-installing common Buildozer dependencies (Platform-Tools & Build-Tools)..."
        # 这里的 sdkmanager 也应该能找到
        sdkmanager "platform-tools" "build-tools;30.0.3" "platforms;android-30"

    # 6. Run buildozer compilation
    - name: Run Buildozer Android Debug
      run: buildozer android debug

    # 7. Upload generated APK file as an artifact
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: bin/*.apk
