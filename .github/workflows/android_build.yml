name: Android Build with Kivy-A.T.

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      # Default Android SDK path used by Buildozer
      ANDROID_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk

    steps:
    - uses: actions/checkout@v4

    # Install Buildozer environment dependencies
    - name: Set up Buildozer Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential python3-pip git openjdk-17-jdk

    # Ensure command-line tools (wget, unzip) are installed for later steps
    - name: Ensure Wget and Unzip Tools
      run: |
        sudo apt install -y wget unzip

    # Install Python dependencies
    - name: Install Python Dependencies
      run: |
        pip install buildozer pip
        pip install cython==0.29.36

    # Accept Android SDK Licenses (to fix "license not accepted" error)
    - name: Accept Android SDK Licenses
      run: |
        mkdir -p $ANDROID_HOME/licenses
        echo "2433ddef7fe487ef9c12257c191a92e18ae5703f" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b940e6990c46a6f1317565b535028883d6a" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
    # Manually install SDK Command-Line Tools (to fix "sdkmanager not installed" error)
    - name: Install Latest SDK Command-Line Tools
      run: |
        TOOLS_ZIP="cmdline-tools.zip"
        
        # Download and unzip the latest command-line tools bundle
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8551475_latest.zip -O $TOOLS_ZIP
        
        # Create target directory and unzip
        mkdir -p $ANDROID_HOME/cmdline-tools/latest
        unzip -q $TOOLS_ZIP -d $ANDROID_HOME/cmdline-tools/latest/
        
        # Move tools to the expected directory structure for sdkmanager
        mv $ANDROID_HOME/cmdline-tools/latest/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
        
        # Cleanup
        rm $TOOLS_ZIP

    # Run buildozer compilation
    - name: Run Buildozer Android Debug
      run: buildozer android debug

    # Upload generated APK file as an artifact
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: bin/*.apk
